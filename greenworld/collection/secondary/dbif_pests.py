"""
This script queries and inserts relevant phytophagous insect species into a seed data file
"""
from typing import List
import urllib.request
import ssl
import re
from greenworld.collection.base import BaseDataCollector

class DbifPestDataCollector(BaseDataCollector):

    def get_pest_species(self, species: str):
        """
        Extract the list of pests for a given host plant
        """
        self.gw.log(f"Retrieving pests for {species}...")
        context = ssl.create_default_context()
        context.check_hostname = False
        context.verify_mode = ssl.CERT_NONE

        # Find the plant species's host ID
        request = urllib.request.Request(
            "https://dbif.brc.ac.uk/hosts.aspx",
            method="POST",
            data=bytes(urllib.parse.urlencode({
                "ctl00$cphBody$txtSrchHost": species,
                "ctl00$cphBody$btnSearchHost": "Display",
                "__VIEWSTATE": "/wEPDwUJNzQ0MDk4MTU2D2QWAmYPZBYCAgMPZBYCAgEPZBYIAgEPEA8WBh4NRGF0YVRleHRGaWVsZAUIaG9zdG5hbWUeDkRhdGFWYWx1ZUZpZWxkBQhob3N0cmFuax4LXyFEYXRhQm91bmRnZBAV4AEKLSBTZWxlY3QgLQtBY2FudGhhY2VhZQlBY2VyYWNlYWULQWNoYXJpYWNlYWUJQWRveGFjZWFlCUFnYXZhY2VhZQlBaXpvYWNlYWUMQWxpc21hdGFjZWFlDUFtYXJhbnRoYWNlYWUOQW1hcnlsbGlkYWNlYWUNQW5hY2FyZGlhY2VhZQtBbm5vbmlhY2VhZQtBcG9jeW5hY2VhZQ1BcXVpZm9saWFjZWFlB0FyYWNlYWUKQXJhbGlhY2VhZQ1BcmF1Y2FyaWFjZWFlEEFyaXN0b2xvY2hpYWNlYWUOQXNjbGVwaWFkYWNlYWUKQXpvbGxhY2VhZQ1CYWxzYW1pbmFjZWFlC0JlZ29uaWFjZWFlDUJlcmJlcmlkYWNlYWUKQmV0dWxhY2VhZQxCaWdub25pYWNlYWUIQml4YWNlYWULQm9tYmFjYWNlYWUMQm9yYWdpbmFjZWFlDEJyb21lbGlhY2VhZQxCdWRkbGVqYWNlYWUKQnV0b21hY2VhZQhCdXhhY2VhZQlDYWN0YWNlYWUPQ2FsbGl0cmljaGFjZWFlDUNhbXBhbnVsYWNlYWUMQ2FubmFiaWFjZWFlCUNhbm5hY2VhZQ1DYXBwYXJpZGFjZWFlDkNhcHJpZm9saWFjZWFlCkNhcmljYWNlYWUPQ2FyeW9waHlsbGFjZWFlDUNhc3VhcmluYWNlYWUMQ2VsYXN0cmFjZWFlD0NlcGhhbG90YXhhY2VhZRBDZXJhdG9waHlsbGFjZWFlDkNoZW5vcG9kaWFjZWFlEENocnlzb2JhbGFuYWNlYWUJQ2lzdGFjZWFlDENvbWJyZXRhY2VhZQ1Db21tZWxpbmFjZWFlCkNvbXBvc2l0YWUOQ29udm9sdnVsYWNlYWUMQ29yaWFyaWFjZWFlCUNvcm5hY2VhZQpDb3J5bGFjZWFlDENyYXNzdWxhY2VhZQpDcnVjaWZlcmFlDUN1Y3VyYml0YWNlYWUMQ3VwcmVzc2FjZWFlCkN5Y2FkYWNlYWUKQ3lwZXJhY2VhZQ1EaW9zY29yZWFjZWFlC0RpcHNhY2FjZWFlC0Ryb3NlcmFjZWFlCUViZW5hY2VhZQxFbGFlYWduYWNlYWUORWxhZW9jYXJwYWNlYWULRW1wZXRyYWNlYWUMRXBhY3JpZGFjZWFlDEVxdWlzZXRhY2VhZQlFcmljYWNlYWUPRXJ5dGhyb3h5bGFjZWFlDkVzY2FsbG9uaWFjZWFlDUV1cGhvcmJpYWNlYWUIRmFnYWNlYWUORmxhY291cnRpYWNlYWUPRmxhZ2VsbGFyaWFjZWFlC0Z1bWFyaWFjZWFlCkdhcnJ5YWNlYWUMR2VudGlhbmFjZWFlC0dlcmFuaWFjZWFlDEdlc25lcmlhY2VhZQ5HbGVpY2hlbmlhY2VhZQlHbmV0YWNlYWUMR29vZGVuaWFjZWFlCUdyYW1pbmVhZQ9Hcm9zc3VsYXJpYWNlYWUMSGFsb3JhZ2FjZWFlDkhhbWFtZWxpZGFjZWFlDUhlbGljb25pYWNlYWUQSGlwcG9jYXN0YW5hY2VhZQ1IaXBwdXJpZGFjZWFlDUh5ZHJhbmdlYWNlYWUQSHlkcm9jaGFyaXRhY2VhZQ9IeWRyb2NvdHlsYWNlYWUPSHlkcm9waHlsbGFjZWFlEEh5bWVub3BoeWxsYWNlYWUMSHlwZXJpY2FjZWFlC0ljYWNpbmFjZWFlC0lsbGljaWFjZWFlCUlyaWRhY2VhZQxKdWdsYW5kYWNlYWUJSnVuY2FjZWFlDUp1bmNhZ2luYWNlYWUITGFiaWF0YWUJTGF1cmFjZWFlDUxlY3l0aGlkYWNlYWULTGVndW1pbm9zYWUJTGVtbmFjZWFlEExlbnRpYnVsYXJpYWNlYWUJTGlsaWFjZWFlCExpbmFjZWFlCUxvYXNhY2VhZQtMb2dhbmlhY2VhZRBMb21hcmlvcHNpZGFjZWFlDExvcmFudGhhY2VhZQ1MeWNvcG9kaWFjZWFlCkx5dGhyYWNlYWUMTWFnbm9saWFjZWFlCU1hbHZhY2VhZQtNYXJhbnRhY2VhZQxNYXJzaWxlYWNlYWUPTWVsYXN0b21hdGFjZWFlCU1lbGlhY2VhZQ5NZW5pc3Blcm1hY2VhZQ1NZW55YW50aGFjZWFlC01vbmltaWFjZWFlEE1vbm9jb3R5bGVkb25lYWUITW9yYWNlYWUITXVzYWNlYWULTXlvcG9yYWNlYWUKTXlyaWNhY2VhZQ1NeXJpc3RpY2FjZWFlC015cnNpbmFjZWFlCU15cnRhY2VhZQxOZXBlbnRoYWNlYWUKTm9sYW5hY2VhZQ1OeWN0YWdpbmFjZWFlDE55bXBoYWVhY2VhZQlPY2huYWNlYWUIT2xlYWNlYWUMT2xlYW5kcmFjZWFlCk9uYWdyYWNlYWULT3JjaGlkYWNlYWUNT3JvYmFuY2hhY2VhZQtPeGFsaWRhY2VhZQtQYWVvbmlhY2VhZQZQYWxtYWULUGFuZGFuYWNlYWUMUGFwYXZlcmFjZWFlDVBhcGlsaW9uYWNlYWUNUGFybmFzc2lhY2VhZQ5QYXNzaWZsb3JhY2VhZQtQZWRhbGlhY2VhZQ5QaHl0b2xhY2NhY2VhZQhQaW5hY2VhZQpQaXBlcmFjZWFlDlBpdHRvc3BvcmFjZWFlDlBsYW50YWdpbmFjZWFlC1BsYXRhbmFjZWFlDlBsdW1iYWdpbmFjZWFlDVBvZG9jYXJwYWNlYWUNUG9sZW1vbmlhY2VhZQxQb2x5Z2FsYWNlYWUMUG9seWdvbmFjZWFlDVBvbHlwb2RpYWNlYWUOUG9udGVkZXJpYWNlYWUNUG9ydHVsYWNhY2VhZRBQb3RhbW9nZXRvbmFjZWFlC1ByaW11bGFjZWFlClByb3RlYWNlYWUKUHVuaWNhY2VhZQpQeXJvbGFjZWFlDVJhbnVuY3VsYWNlYWUKUmVzZWRhY2VhZQpSaGFtbmFjZWFlDlJoaXpvcGhvcmFjZWFlCFJvc2FjZWFlCVJ1YmlhY2VhZQpSdXBwaWFjZWFlCFJ1dGFjZWFlClNhbGljYWNlYWUMU2FsdmluaWFjZWFlC1NhbnRhbGFjZWFlC1NhcGluZGFjZWFlClNhcG90YWNlYWUNU2F4aWZyYWdhY2VhZRBTY2hldWNoemVyaWFjZWFlDFNjaGl6YWVhY2VhZRBTY3JvcGh1bGFyaWFjZWFlD1NlbGFnaW5lbGxhY2VhZQ1TaW1hcm91YmFjZWFlD1Npbm9wdGVyaWRhY2VhZQpTb2xhbmFjZWFlDlNvbm5lcmF0aWFjZWFlDVNwYXJnYW5pYWNlYWUNU3RhbmdlcmlhY2VhZQ1TdGFwaHlsZWFjZWFlDVN0ZXJjdWxpYWNlYWUOU3RyZWxpdHppYWNlYWULU3R5cmFjYWNlYWUMVGFtYXJpY2FjZWFlCFRheGFjZWFlC1RheG9kaWFjZWFlCFRoZWFjZWFlD1RoZW9waHJhc3RhY2VhZQ1UaHltZWxhZWFjZWFlCVRpbGlhY2VhZQlUcmFwYWNlYWULVHJpbGxpYWNlYWUNVHJvcGFlb2xhY2VhZQlUeXBoYWNlYWUIVWxtYWNlYWUMVW1iZWxsaWZlcmFlClVydGljYWNlYWUNVmFsZXJpYW5hY2VhZQtWZXJiZW5hY2VhZQlWaW9sYWNlYWUIVml0YWNlYWUJWmFtaWFjZWFlEFphbm5pY2hlbGxpYWNlYWUNWmluZ2liZXJhY2VhZQtab3N0ZXJhY2VhZQ5aeWdvcGh5bGxhY2VhZRXgAQAQVjE3MDEzMzAwODAwMDAwMBBWMTcwMTExMDAxMDAwMDAwEFYxNzAxMDMwMDE0MDAwMDAQVjE3MDEzNjAwMzAwMDAwMBBWMTcwMjA0MDAxMTAwMDAwEFYxNzAxMDcwMDQwMDAwMDAQVjE3MDIwMTAwMTAwMDAwMBBWMTcwMTA3MDA1MDAwMDAwEFYxNzAyMDQwMDUwMDAwMDAQVjE3MDExMTAwMTEwMDAwMBBWMTcwMTAxMDAzMzAwMDAwEFYxNzAxMzIwMDMwMDAwMDAQVjE3MDExMjAwMTAwMDAwMBBWMTcwMjA2MDAxMDAwMDAwEFYxNzAxMTkwMDIwMDAwMDAQVjE2MDIwMjAwMjEwMDAwMBBWMTcwMTIxMDAxMDAwMDAwEFYxNzAxMzIwMDMxMDAwMDAQVjE1MDUwNjAwMTAwMDAwMBBWMTcwMTA5MDA0MDAwMDAwEFYxNzAxMDcwMDExMDAwMDAQVjE3MDEwMTAwMzAwMDAwMBBWMTcwMTI3MDAxMDAwMDAwEFYxNzAxMzMwMDUxMDAwMDAQVjE3MDEwNTAwMTEwMDAwMBBWMTcwMTA4MDAyMjAwMDAwEFYxNzAxMzMwMDIwMDAwMDAQVjE3MDIwNDAwNDEwMDAwMBBWMTcwMTMyMDAxMDAwMDAwEFYxNzAyMDEwMDIwMDAwMDAQVjE3MDExMjAwMzAwMDAwMBBWMTcwMTIwMDAxMTAwMDAwEFYxNzAxMTcwMDcwMDAwMDAQVjE3MDEzNTAwMTAwMDAwMBBWMTcwMTI0MDAyMDAwMDAwEFYxNzAyMDgwMDExMDAwMDAQVjE3MDEwMjAwMjEwMDAwMBBWMTcwMTM2MDAyMDAwMDAwEFYxNzAxMDMwMDEzMDAwMDAQVjE3MDEwNzAwMjAwMDAwMBBWMTcwMTI3MDAzMTAwMDAwEFYxNzAxMTIwMDIwMDAwMDAQVjE2MDIwMjAwMjIwMDAwMBBWMTcwMTAxMDA1MDAwMDAwEFYxNzAxMDcwMDYwMDAwMDAQVjE3MDExNTAwMTEwMDAwMBBWMTcwMTA1MDAyMDAwMDAwEFYxNzAxMTcwMDQzMDAwMDAQVjE3MDIwMzAwMTEwMDAwMBBWMTcwMTM3MDAxMDAwMDAwEFYxNzAxMzMwMDMwMDAwMDAQVjE3MDExMTAwMDEwMDAwMBBWMTcwMTE5MDAxMDAwMDAwEFYxNzAxMjcwMDIwMDAwMDAQVjE3MDExNTAwMzAwMDAwMBBWMTcwMTAyMDAzMDAwMDAwEFYxNzAxMjAwMDEwMDAwMDAQVjE2MDIwMjAwMjAwMDAwMBBWMTYwMTAzMDAxMDAwMDAwEFYxNzAyMDgwMDEwMDAwMDAQVjE3MDIwNDAwNzAwMDAwMBBWMTcwMTM2MDA1MDAwMDAwEFYxNzAxMTYwMDEwMDAwMDAQVjE3MDEzMDAwMTEwMDAwMBBWMTcwMTE3MDAzMDAwMDAwEFYxNzAxMDgwMDAxMDAwMDAQVjE3MDEyOTAwNDAwMDAwMBBWMTcwMTI5MDA0MTAwMDAwEFYxNTA0MDEwMDEwMDAwMDAQVjE3MDEyOTAwMTAwMDAwMBBWMTcwMTA5MDAxMjAwMDAwEFYxNzAxMTUwMDcwMDAwMDAQVjE3MDEyMjAwMTAwMDAwMBBWMTcwMTI3MDAzMDAwMDAwEFYxNzAxMDMwMDAxMDAwMDAQVjE3MDIwMzAwMTIwMDAwMBBWMTcwMTAyMDAyMDAwMDAwEFYxNzAxMTkwMDExMDAwMDAQVjE3MDEzMjAwNDAwMDAwMBBWMTcwMTA5MDAyMDAwMDAwEFYxNzAxMzMwMDgyMDAwMDAQVjE1MDUwNDAwMjMwMDAwMBBWMTYwNDAxMDAxMDAwMDAwEFYxNzAxMzUwMDIxMDAwMDAQVjE3MDIwOTAwMTAwMDAwMBBWMTcwMTE1MDA4MDAwMDAwEFYxNzAxMTcwMDUwMDAwMDAQVjE3MDExNTAwMDEwMDAwMBBWMTcwMjA4MDAxNDAwMDAwEFYxNzAxMTEwMDMwMDAwMDAQVjE3MDExNzAwNjAwMDAwMBBWMTcwMTE1MDA2MDAwMDAwEFYxNzAyMDEwMDMwMDAwMDAQVjE3MDExOTAwMzAwMDAwMBBWMTcwMTMzMDAyMTAwMDAwEFYxNTA1MDQwMDEwMDAwMDAQVjE3MDEwNTAwMTAwMDAwMBBWMTcwMTEyMDAzMTAwMDAwEFYxNzAxMDEwMDIyMDAwMDAQVjE3MDIwNDAwNjAwMDAwMBBWMTcwMTI1MDAxMDAwMDAwEFYxNzAyMDQwMDQwMDAwMDAQVjE3MDIwMjAwMjAwMDAwMBBWMTcwMTMzMDEwMDAwMDAwEFYxNzAxMDEwMDMxMDAwMDAQVjE3MDExNzAwNDUwMDAwMBBWMTcwMTE0MDAwMDAwMDAwEFYxNzAyMDYwMDIwMDAwMDAQVjE3MDEzMzAwNzAwMDAwMBBWMTcwMjA0MDAxMDAwMDAwEFYxNzAxMDkwMDEwMDAwMDAQVjE3MDEwMzAwMTEwMDAwMBBWMTcwMTMyMDAzMjAwMDAwEFYxNTA1MDQwMDIyMDAwMDAQVjE3MDExODAwMTAwMDAwMBBWMTUwMjAxMDAxMDAwMDAwEFYxNzAxMTcwMDEwMDAwMDAQVjE3MDEwMTAwMzIwMDAwMBBWMTcwMTA4MDAyMDAwMDAwEFYxNzAyMDgwMDE2MDAwMDAQVjE1MDUwNTAwMTAwMDAwMBBWMTcwMTE3MDA0NDAwMDAwEFYxNzAxMTAwMDEyMDAwMDAQVjE3MDEwMTAwMTEwMDAwMBBWMTcwMTMyMDA1MDAwMDAwEFYxNzAxMDEwMDIzMDAwMDAQVjE3MDIwMDAwMDAwMDAwMBBWMTcwMTI0MDA0MDAwMDAwEFYxNzAyMDgwMDEyMDAwMDAQVjE3MDEzMzAwNzEwMDAwMBBWMTcwMTI2MDAxMDAwMDAwEFYxNzAxMDEwMDM1MDAwMDAQVjE3MDEzMTAwMDEwMDAwMBBWMTcwMTE3MDA0MTAwMDAwEFYxNzAxMTYwMDAxMDAwMDAQVjE3MDEzMzAwMzEwMDAwMBBWMTcwMTA3MDA3MTAwMDAwEFYxNzAxMDEwMDQwMDAwMDAQVjE3MDEwNTAwMTIwMDAwMBBWMTcwMTMyMDAyMDAwMDAwEFYxNTA1MDQwMDIxMDAwMDAQVjE3MDExNzAwNDAwMDAwMBBWMTcwMjA1MDAxMDAwMDAwEFYxNzAxMzMwMDYwMDAwMDAQVjE3MDEwOTAwMzAwMDAwMBBWMTcwMTAxMDAyMDAwMDAwEFYxNzAyMDkwMDExMDAwMDAQVjE3MDIwNzAwMDEwMDAwMBBWMTcwMTAyMDAxMDAwMDAwEFYxNzAxMTQwMDEwMDAwMDAQVjE3MDExNTAwNTAwMDAwMBBWMTcwMTAzMDAxMjAwMDAwEFYxNzAxMzMwMDgxMDAwMDAQVjE3MDEwNzAwNzAwMDAwMBBWMTYwMjAyMDAxMDAwMDAwEFYxNzAxMDEwMDM0MDAwMDAQVjE3MDExNTAwOTAwMDAwMBBWMTcwMTM0MDAxMDAwMDAwEFYxNzAxMTUwMDIwMDAwMDAQVjE3MDEzMDAwMTAwMDAwMBBWMTYwMjAyMDAyMzAwMDAwEFYxNzAxMzMwMDEwMDAwMDAQVjE3MDEwNDAwMTAwMDAwMBBWMTcwMTIzMDAxMDAwMDAwEFYxNTA1MDQwMDIwMDAwMDAQVjE3MDIwNDAwMzAwMDAwMBBWMTcwMTA3MDAzMDAwMDAwEFYxNzAyMDIwMDUwMDAwMDAQVjE3MDEzMTAwMTAwMDAwMBBWMTcwMTI0MDA0MTAwMDAwEFYxNzAxMTcwMDQyMDAwMDAQVjE3MDEyOTAwMjAwMDAwMBBWMTcwMTAxMDAxMDAwMDAwEFYxNzAxMDIwMDQwMDAwMDAQVjE3MDExMzAwMTAwMDAwMBBWMTcwMTE3MDA0NzAwMDAwEFYxNzAxMTUwMDEwMDAwMDAQVjE3MDEzNjAwMTAwMDAwMBBWMTcwMjAyMDA2MDAwMDAwEFYxNzAxMTAwMDExMDAwMDAQVjE3MDEyODAwMTAwMDAwMBBWMTUwNTA2MDAxMTAwMDAwEFYxNzAxMTgwMDIwMDAwMDAQVjE3MDExMTAwMjEwMDAwMBBWMTcwMTMwMDAxMzAwMDAwEFYxNzAxMTUwMDQwMDAwMDAQVjE3MDIwMjAwMTAwMDAwMBBWMTUwNTAzMDAxMjAwMDAwEFYxNzAxMzMwMDUwMDAwMDAQVjE1MDIwMjAwMTAwMDAwMBBWMTcwMTEwMDAxMDAwMDAwEFYxNTA1MDMwMDExMDAwMDAQVjE3MDEzMzAwNDAwMDAwMBBWMTcwMTE3MDA0NjAwMDAwEFYxNzAyMDcwMDEwMDAwMDAQVjE2MDEwMzAwMzAwMDAwMBBWMTcwMTExMDAyMDAwMDAwEFYxNzAxMDgwMDIxMDAwMDAQVjE3MDIwODAwMTUwMDAwMBBWMTcwMTMwMDAxMjAwMDAwEFYxNzAxMDYwMDEwMDAwMDAQVjE2MDMwMTAwMTAwMDAwMBBWMTYwMjAyMDAxMTAwMDAwEFYxNzAxMDEwMDIxMDAwMDAQVjE3MDEzMTAwMDIwMDAwMBBWMTcwMTE3MDAyMDAwMDAwEFYxNzAxMDgwMDEwMDAwMDAQVjE3MDExNzAwMTEwMDAwMBBWMTcwMjA0MDAyMDAwMDAwEFYxNzAxMDkwMDIxMDAwMDAQVjE3MDIwNzAwMjAwMDAwMBBWMTcwMTI0MDAzMDAwMDAwEFYxNzAxMTkwMDQwMDAwMDAQVjE3MDEyNDAwMTAwMDAwMBBWMTcwMTM2MDA0MDAwMDAwEFYxNzAxMzMwMDkwMDAwMDAQVjE3MDEwMzAwMTAwMDAwMBBWMTcwMTEzMDAyMDAwMDAwEFYxNjAxMDMwMDIwMDAwMDAQVjE3MDIwMjAwNzAwMDAwMBBWMTcwMjA4MDAxMzAwMDAwEFYxNzAyMDIwMDQwMDAwMDAQVjE3MDEwOTAwMTEwMDAwMBQrA+ABZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2cWAWZkAgUPDxYCHgRUZXh0BQh6ZWEgbWF5c2RkAgkPDxYCHwNlZGQCCw88KwALAQAPFgoeB1Zpc2libGVnHghEYXRhS2V5cxYBKClbU3lzdGVtLkRlY2ltYWwsIG1zY29ybGliLCBWZXJzaW9uPTQuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49Yjc3YTVjNTYxOTM0ZTA4OQQ2MTU4HgtfIUl0ZW1Db3VudAIBHglQYWdlQ291bnQCAR4VXyFEYXRhU291cmNlSXRlbUNvdW50AgFkFgJmD2QWAgIBD2QWBmYPDxYCHwMFBDYxNThkZAIBDw8WAh8DBRJHcmFtaW5lYWUgKEZhbWlseSlkZAICDw8WAh8DBTk8aT48YSBocmVmPWhvc3RzcmVzdWx0cy5hc3B4P2hvc3RpZD02MTU4PlplYSBtYXlzPC9hPjwvaT5kZGSLOuoJrVGhB3DZg9JHcSvorqBIEuGUs4gtQulKWpIKog==",
                "__EVENTVALIDATION": "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"
            }), encoding="utf-8"),
            headers={
                "User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36"
            }
        )
        try:
            data = urllib.request.urlopen(request, context=context)
        except:
            self.gw.log(f"Error while querying pests for {species}")
            return []
        results = data.read().decode("utf-8")
        hostid_search = re.search(r"<a href=hostsresults.aspx\?hostid=([0-9]+)>", results)
        if hostid_search is None:
            return []
        hostid = int(hostid_search.group(1))

        # Retrieve the list of pests
        request = urllib.request.Request(
            f"https://dbif.brc.ac.uk/hostsresults.aspx?hostid={hostid}",
            method="GET",
            headers={
                "User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36"
            }
        )
        data = urllib.request.urlopen(request, context=context)
        results = data.read().decode("utf-8")

        species = re.findall(r"<td>[^<]*</td><td>[^<]*</td><td>[^<]*</td><td.+>([^>]+)</a></i>", results)
        return list(map(lambda x: " ".join(x.split(" ")[0:2]), species))


    def matches_input(self, key: str) -> bool:
        return re.match(r"^\(pests\)$", key)


    def collect_data(self, key: dict):
        """
        Goes through the process of adding pest data to a given file
        """

        # Set up the citations
        citation_id = self.populate_works_cited(key, "https://dbif.brc.ac.uk/")

        # Grab pests for each plant species
        for plant in key["plants"] if "plants" in key else []:
            pests = self.get_pest_species(plant["species"])
            self.add_ecology(key, plant, citation_id, pests, "Ecology.PREDATOR")

        # Return the updated data
        return key
